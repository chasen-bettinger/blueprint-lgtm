// Generated by CoffeeScript 1.6.3
(function() {
  var AuthParser, Db, Kit, Logger, Router, TokenMgr, Wrapper, config, kit, log, mod, restify, s_use, server, _i, _len, _ref;

  restify = require('restify');

  Kit = require('./lib/kit').Kit;

  Db = require('./lib/db').Db;

  s_use = require('./lib/server_use');

  config = (require('./lib/config'))();

  Logger = require('./lib/logger').Logger;

  Router = require('./lib/router').Router;

  Wrapper = require('./lib/route_wrapper').Wrapper;

  TokenMgr = require('./lib/token_manager').TokenMgr;

  AuthParser = require('./lib/authorizationParser').AuthParser;

  kit = new Kit;

  kit.add_service('config', config);

  kit.new_service('logger', Logger);

  log = kit.services.logger.log;

  server = restify.createServer({
    log: log
  });

  kit.add_service('server', server);

  kit.new_service('tokenMgr', TokenMgr);

  kit.new_service('db', Db);

  kit.new_service('authParser', AuthParser);

  kit.new_service('router', Router);

  kit.new_service('wrapper', Wrapper);

  server.use(s_use.set_response_headers);

  server.use(restify.queryParser());

  server.use(restify.bodyParser());

  server.use(restify.requestLogger());

  server.use(kit.services.authParser.parseAuthorization);

  server.use(s_use.debug_request);

  _ref = kit.services.config.route_modules;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    mod = _ref[_i];
    if (!(mod.enable === true)) {
      continue;
    }
    kit.new_route_service(mod.name, (require(mod.file))[mod["class"]]);
    kit.services.wrapper.add(mod.name);
  }

  kit.services.router.route_usage();

  server.get(/.*/, restify.serveStatic({
    directory: './html_root',
    "default": 'index.html'
  }));

  server.listen(config.api.port, function() {
    return log.info('Server listening at', server.url);
  });

}).call(this);
