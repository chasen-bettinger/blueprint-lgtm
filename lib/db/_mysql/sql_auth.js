// Generated by CoffeeScript 1.6.3
(function() {
  var E, Q, SqlAuth, cred_col;

  Q = require('q');

  E = require('../../error');

  cred_col = 'eml';

  SqlAuth = (function() {
    function SqlAuth(db, log) {
      this.db = db;
      this.log = log;
      this.table = 'ident';
      this.schema = {
        auth: ['id', 'pwd'],
        update_by_id: ['eml', 'pwd']
      };
      this.db.method_factory(this, 'SqlAuth');
    }

    SqlAuth.prototype.get_auth_credentials = function(conn, cred_name) {
      var f,
        _this = this;
      f = 'DB.SqlAuth.get_auth_credentials:';
      this.log.debug(f, cred_name);
      return Q.resolve().then(function() {
        var sql;
        sql = 'SELECT ' + (_this.schema.auth.join(',')) + ' FROM ' + table + ' WHERE ' + cred_col + '= ? and di= 0';
        return _this.db.sqlQuery(conn, sql, [cred_name]);
      }).then(function(db_rows) {
        if (db_rows.length !== 1 || !db_rows[0].pwd) {
          throw new E.OAuthError(401, 'invalid_client');
        }
        return db_rows[0];
      });
    };

    return SqlAuth;

  })();

  exports.SqlAuth = SqlAuth;

}).call(this);
