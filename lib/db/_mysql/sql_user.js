// Generated by CoffeeScript 1.6.3
(function() {
  var E, Q, SqlUser, table,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  Q = require('q');

  E = require('../../error');

  table = 't1_users';

  SqlUser = (function() {
    function SqlUser(db, log) {
      this.db = db;
      this.log = log;
    }

    SqlUser.prototype.schema = {
      auth: ['id', 'password'],
      create: ['first_name', 'last_name', 'email', 'password'],
      update: ['first_name', 'last_name', 'email', 'password', 'disposal']
    };

    SqlUser.prototype.get_all = function(conn) {
      var f,
        _this = this;
      f = 'DB.SqlUser.get_all:';
      return Q.resolve().then(function() {
        var sql;
        sql = 'SELECT * FROM m1_users';
        return _this.db.sqlQuery(conn, sql);
      }).then(function(db_rows) {
        return db_rows;
      });
    };

    SqlUser.prototype.get_auth_credentials = function(conn, username) {
      var f,
        _this = this;
      f = 'DB.SqlUser.get_auth_credentials:';
      this.log.debug(f, username);
      return Q.resolve().then(function() {
        var sql;
        sql = 'SELECT ' + (_this.schema.auth.join(',')) + ' FROM ' + table + ' WHERE email= ? and disposal= 0';
        return _this.db.sqlQuery(conn, sql, [username]);
      }).then(function(db_rows) {
        if (db_rows.length !== 1 || !db_rows[0].password) {
          throw new E.OAuthError(401, 'invalid_client');
        }
        return db_rows[0];
      });
    };

    SqlUser.prototype.create = function(conn, new_values) {
      var f, nm, val,
        _this = this;
      f = 'DB.SqlUser.create:';
      this.log.debug(f, new_values);
      for (nm in new_values) {
        val = new_values[nm];
        if (__indexOf.call(this.schema.create, nm) < 0) {
          throw new E.ServerError('Invalid User Insert Column', {
            col: nm,
            value: val
          });
        }
      }
      return Q.resolve().then(function() {
        var arg, cols, qs, sql;
        cols = [];
        qs = [];
        arg = [];
        for (nm in new_values) {
          val = new_values[nm];
          cols.push(nm);
          qs.push('?');
          arg.push(val);
        }
        sql = 'INSERT INTO ' + table + ' (' + (cols.join(',')) + ') VALUES (' + (qs.join(',')) + ')';
        return _this.db.sqlQuery(conn, sql, arg);
      }).then(function(db_result) {
        _this.log.debug(f, db_result);
        if (db_result.affectedRows !== 1) {
          throw new E.DbError('User Insert Failed');
        }
        return db_result;
      });
    };

    SqlUser.prototype.update = function(conn, id, new_values) {
      var f, nm, val,
        _this = this;
      f = 'DB.SqlUser.update:';
      this.log.debug(f, id, new_values);
      for (nm in new_values) {
        val = new_values[nm];
        if (__indexOf.call(this.schema.create, nm) < 0) {
          throw new E.DbError('Invalid User Update Column', {
            col: nm,
            value: val
          });
        }
      }
      return Q.resolve().then(function() {
        var arg, cols, sql;
        cols = [];
        arg = [];
        for (nm in new_values) {
          val = new_values[nm];
          cols.push(nm + '= ?');
          arg.push(val);
        }
        arg.push(id);
        sql = 'UPDATE ' + table + ' SET ' + (cols.join(',')) + ' WHERE id= ?';
        return _this.db.sqlQuery(conn, sql, arg);
      }).then(function(db_result) {
        _this.log.debug(f, db_result);
        if (db_result.affectedRows !== 1) {
          throw new E.DbError('User Update Failed');
        }
        return db_result;
      });
    };

    return SqlUser;

  })();

  exports.SqlUser = SqlUser;

}).call(this);
