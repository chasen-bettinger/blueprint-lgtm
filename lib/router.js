// Generated by CoffeeScript 1.6.3
(function() {
  var Q, Router, log_map, usage, use_map,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Q = require('q');

  log_map = {
    get: 'GET ',
    post: 'POST',
    put: 'PUT ',
    del: 'DEL '
  };

  use_map = {
    get: 'GET',
    post: 'POST',
    put: 'PUT',
    del: 'DEL'
  };

  usage = [];

  Router = (function() {
    function Router(kit) {
      this.route_usage = __bind(this.route_usage, this);
      kit.services.logger.log.info('Initializing Router...');
      this.log = kit.services.logger.log;
      this.pfx = kit.services.config.route_prefix.api;
      this.template = kit.services.template_use;
      this.server = kit.services.server;
      this.usage = [];
    }

    Router.prototype.add_route = function(verb, route, func) {
      var nm, v, val, verbs, _i, _len, _results;
      this.usage.push({
        verb: use_map[verb],
        route: route,
        Param: (function() {
          var _ref, _results;
          _ref = func('use');
          _results = [];
          for (nm in _ref) {
            val = _ref[nm];
            _results.push({
              name: nm,
              format: val
            });
          }
          return _results;
        })()
      });
      verbs = [verb];
      if (verb === 'del' || verb === 'put') {
        verbs.push('post');
      }
      _results = [];
      for (_i = 0, _len = verbs.length; _i < _len; _i++) {
        v = verbs[_i];
        this.log.info('\t', log_map[v], this.pfx + '' + route);
        _results.push(this.server[v](this.pfx + '' + route, func));
      }
      return _results;
    };

    Router.prototype.make_tbl = function() {
      var rec;
      return {
        Route: (function() {
          var _i, _len, _ref, _results;
          _ref = this.usage;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            rec = _ref[_i];
            _results.push(rec);
          }
          return _results;
        }).call(this)
      };
    };

    Router.prototype.route_usage = function() {
      var f,
        _this = this;
      f = 'Router:route_usage';
      return this.server.get(this.pfx, function(q, r, n) {
        var e, result;
        if (q.params.format === 'json') {
          r.send(_this.usage);
        } else {
          try {
            result = _this.template.render('Usage', 'Top', 'welcome', _this.make_tbl());
          } catch (_error) {
            e = _error;
            _this.log.debug(e, e.stack);
            throw e;
          }
          r.set('Content-Type', 'text/html');
          r.send(200, result, {
            'Content-Type': 'text/html; charset=utf-8'
          });
        }
        return n();
      });
    };

    return Router;

  })();

  exports.Router = Router;

}).call(this);
