// Generated by CoffeeScript 1.8.0
(function() {
  var AWS, Q, SES;

  Q = require('q');

  AWS = require('aws-sdk');

  SES = (function() {
    function SES(kit) {
      this.log = kit.services.logger.log;
      this.config = kit.services.config.ses;
      AWS.config.update({
        accessKeyId: this.config.accessKeyId,
        secretAccessKey: this.config.secretAccessKey,
        region: this.config.region
      });
      this.ses = new AWS.SES();
      this.template = kit.services.template;
    }

    SES.prototype.send = function(type, data) {
      var message, spec;
      spec = this.config.emails[type];
      message = this._composeMsgFrom(spec, data);
      this.log.debug('SES:send:', 'sending message:', message);
      return Q.ninvoke(this.ses, 'sendEmail', message);
    };

    SES.prototype._composeMsgFrom = function(spec, data) {
      var f, recipient, send_to, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6;
      f = 'SES._composeMsgFrom:';
      this.log.debug(f, spec, data);
      send_to = false;
      if (this.config.debug_email !== false) {
        send_to = this.config.debug_email;
      } else {
        recipient = data.Recipient[0];
        send_to = typeof recipient === 'string' ? recipient : recipient.eml;
      }
      return {
        Destination: {
          ToAddresses: [send_to],
          BccAddresses: (_ref = spec.BccAddresses) != null ? _ref : this.config["default"].BccAddresses,
          CcAddresses: (_ref1 = spec.CcAddresses) != null ? _ref1 : this.config["default"].CcAddresses
        },
        Source: (_ref2 = spec.Source) != null ? _ref2 : this.config["default"].Source,
        ReplyToAddresses: (_ref3 = spec.ReplyToAddresses) != null ? _ref3 : this.config["default"].ReplyToAddresses,
        ReturnPath: (_ref4 = spec.ReturnPath) != null ? _ref4 : this.config["default"].ReturnPath,
        Message: {
          Subject: {
            Data: (_ref5 = spec.Subject) != null ? _ref5 : 'Default Email Subject'
          },
          Body: {
            Html: {
              Data: this.template.render(spec.model, spec.tmpl, spec.page, data)
            },
            Text: {
              Data: (_ref6 = spec.Text) != null ? _ref6 : 'Default Email Text'
            }
          }
        }
      };
    };

    return SES;

  })();

  exports.SES = SES;

}).call(this);
